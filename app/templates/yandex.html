{% extends "base.html" %}

{% block title %}Яндекс.Музыка{% endblock %}

{% block content %}
<div class="search-container">
    <h2 class="mb-4">Поиск в Яндекс.Музыке</h2>
    <div class="input-group mb-4">
        <input type="text" id="searchQuery" class="form-control" placeholder="Введите название трека...">
        <button id="searchBtn" class="btn btn-warning">Поиск</button>
    </div>

    <div id="resultsContainer">
        <!-- Результаты будут здесь -->
    </div>
</div>

{% block scripts %}
<script>
$(document).ready(function() {
    $('#searchBtn').click(searchYandex);
    $('#searchQuery').keypress(function(e) {
        if(e.which == 13) searchYandex();
    });

    function searchYandex() {
        const query = $('#searchQuery').val();
        if(!query) return;

        $('#resultsContainer').html('<div class="text-center">Идет поиск...</div>');

        $.get('/api/yandex/search', { q: query }, function(data) {
            let html = '';
            data.forEach(track => {
                const duration = new Date(track.track_duration_ms).toISOString().substr(14, 5);
                const coverUrl = track.cover_uri ? `https://${track.cover_uri.replace('%%', '200x200')}` : 'https://via.placeholder.com/200';
                
                html += `
                <div class="card media-card">
                    <div class="row g-0">
                        <div class="col-md-3">
                            <a href="${track.track_url}" target="_blank">
                                <img src="${coverUrl}" class="img-fluid rounded-start">
                            </a>
                        </div>
                        <div class="col-md-9">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <a href="${track.track_url}" target="_blank">${track.track_title}</a>
                                </h5>
                                <p class="card-text">
                                    <small class="text-muted">${track.author}</small><br>
                                    <small>${duration}</small>
                                </p>
                                <div class="d-flex justify-content-between">
                                    <a href="${track.track_url}" class="btn btn-outline-warning" target="_blank">Открыть в Яндекс</a>
                                    <button class="btn btn-warning download-btn" 
                                        data-url="${track.track_url}" data-type="audio">
                                        Скачать MP3
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            $('#resultsContainer').html(html || '<div class="text-center">Ничего не найдено</div>');
            bindDownloadButtons();
        });
    }

    function bindDownloadButtons() {
        $('.download-btn').click(function() {
            const url = $(this).data('url');
            const type = $(this).data('type');
            downloadMedia(url, type);
        });
    }

    function downloadMedia(url, type) {
        const button = $(`.download-btn[data-url="${url}"]`);
        const originalText = button.text();
    
        button.prop('disabled', true).text('Скачивание...');
        
        $.post('/api/download', {
            url: url,
            type: type,
            format: 'mp3'
        }, function(response) {
            if(response.success) {
                button.text('Скачано!');
                setTimeout(() => {
                    window.open('/downloads/' + response.path.split('/').pop(), '_blank');
                    button.prop('disabled', false).text(originalText);
                }, 1000);
            } else {
                button.text('Ошибка!').addClass('btn-danger');
                setTimeout(() => {
                    button.prop('disabled', false).text(originalText).removeClass('btn-danger');
                }, 2000);
            }
        }).fail(function() {
            button.text('Ошибка!').addClass('btn-danger');
            setTimeout(() => {
                button.prop('disabled', false).text(originalText).removeClass('btn-danger');
            }, 2000);
        });
    }
});
</script>
{% endblock %}
{% endblock %}