{% extends "base.html" %}

{% block title %}YouTube Search{% endblock %}

{% block content %}
<div class="search-container">
    <h2 class="mb-4">Поиск на YouTube</h2>
    <div class="input-group mb-4">
        <input type="text" id="searchQuery" class="form-control" placeholder="Введите название видео...">
        <button id="searchBtn" class="btn btn-danger">Поиск</button>
    </div>

    <div id="resultsContainer">
        <!-- Результаты будут здесь -->
    </div>
</div>

{% block scripts %}
<script>
$(document).ready(function() {
    $('#searchBtn').click(searchYouTube);
    $('#searchQuery').keypress(function(e) {
        if(e.which == 13) searchYouTube();
    });

    function searchYouTube() {
        const query = $('#searchQuery').val();
        if(!query) return;

        $('#resultsContainer').html('<div class="text-center">Идет поиск...</div>');

        $.get('/api/youtube/search', { q: query }, function(data) {
            let html = '';
            data.forEach(video => {
                html += `
                <div class="card media-card">
                    <div class="row g-0">
                        <div class="col-md-4">
                            <a href="${video.video_url}" target="_blank">
                                <img src="${video.video_thumbnails.high.url}" class="img-fluid rounded-start">
                            </a>
                        </div>
                        <div class="col-md-8">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <a href="${video.video_url}" target="_blank">${video.video_title}</a>
                                </h5>
                                <p class="card-text">
                                    <small class="text-muted">${video.channel_title}</small><br>
                                    <small>${video.video_views} просмотров</small>
                                </p>
                                <div class="d-flex justify-content-between">
                                    <a href="${video.video_url}" class="btn btn-outline-danger" target="_blank">Открыть в YouTube</a>
                                    <div>
                                        <button class="btn btn-danger download-btn" 
                                            data-url="${video.video_url}" data-type="video">
                                            Скачать MP4
                                        </button>
                                        <button class="btn btn-secondary download-btn ms-2" 
                                            data-url="${video.video_url}" data-type="audio">
                                            Скачать MP3
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            $('#resultsContainer').html(html || '<div class="text-center">Ничего не найдено</div>');
            bindDownloadButtons();
        });
    }

    function bindDownloadButtons() {
        $('.download-btn').click(function() {
            const url = $(this).data('url');
            const type = $(this).data('type');
            downloadMedia(url, type);
        });
    }

    function downloadMedia(url, type) {
        const format = type === 'video' ? 'mp4' : 'mp3';
        const button = $(`.download-btn[data-url="${url}"][data-type="${type}"]`);
        const originalText = button.text();
        
        button.prop('disabled', true).text('Скачивание...');
        
        $.post('/api/download', {
            url: url,
            type: type,
            format: format
        }, function(response) {
            if(response.success) {
                button.text('Скачано!');
                setTimeout(() => {
                    window.open('/downloads/' + response.path.split('/').pop(), '_blank');
                    button.prop('disabled', false).text(originalText);
                }, 1000);
            } else {
                button.text('Ошибка!').addClass('btn-danger');
                setTimeout(() => {
                    button.prop('disabled', false).text(originalText).removeClass('btn-danger');
                }, 2000);
            }
        }).fail(function() {
            button.text('Ошибка!').addClass('btn-danger');
            setTimeout(() => {
                button.prop('disabled', false).text(originalText).removeClass('btn-danger');
            }, 2000);
        });
    }
});
</script>
{% endblock %}
{% endblock %}